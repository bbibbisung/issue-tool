<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>이슈 분류 툴 (FM / NK)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="page">
  <header class="header">
    <h1>이슈 분류 툴</h1>
    <p>FM(신월동행), NK(니케) 모니터링용 이슈 자동 분류 도구</p>
  </header>

  <!-- 1. 이슈 입력 -->
  <section class="card">
    <h2>1. 이슈 입력</h2>
    <form method="post" class="issue-form">
      <!-- mode는 유지하되, 실제 동작은 action=classify 기준으로 처리 -->
      <input type="hidden" name="mode" value="classify">
      <input type="hidden" name="action" value="classify">

      <div class="form-row">
        <label for="game">게임 선택</label>
        <select id="game" name="game">
          <option value="FM" {% if game == 'FM' %}selected{% endif %}>FM (신월동행)</option>
          <option value="NK" {% if game == 'NK' %}selected{% endif %}>NK (니케)</option>
        </select>
      </div>

      <div class="form-row">
        <label for="content">제목/내용</label>
        <textarea id="content" name="content" rows="6"
                  placeholder="문의 제목/내용을 그대로 붙여 넣으세요.">{{ content or '' }}</textarea>
      </div>

      <div class="form-row buttons">
        <button type="submit">분류 실행</button>
      </div>
    </form>
  </section>

  {% if final_label %}
  <!-- 2. 최종 판단 결과 영역 -->
  <section class="results">
    <div class="card">
      <h2>2. 최종 판단</h2>
      <div class="final-label">
        {% if final_label == 'issue' %}
          <span class="badge badge-issue">ISSUE</span>
        {% else %}
          <span class="badge badge-non">NON ISSUE</span>
        {% endif %}

        {% if feedback_applied %}
          <span class="badge badge-feedback">나딘 피드백 적용</span>
        {% endif %}
      </div>
      <p class="final-desc">
        RULES와 머신러닝 결과를 종합한 최종 판단입니다.
        {% if feedback_applied and feedback_correct_label %}
          (이 케이스는 기록된 피드백 기준으로 최종 라벨을 덮어써서 표시합니다.)
        {% endif %}
      </p>

      <!-- (4순위 패치) 게임 선택 ↔ 캐릭터 검출 뒤틀림 경고 -->
      {% if game_warning %}
      <div
        class="game-warning"
        style="margin-top:8px;padding:10px 12px;border-radius:8px;
               border:1px solid #f97373;background:rgba(248,113,113,0.12);
               font-size:13px;line-height:1.5;color:#fecaca;">
        <strong>주의:</strong> {{ game_warning }}
      </div>
      {% endif %}

      <!-- === 3순위 패치: ISSUE / NON ISSUE 배지에 업무 기준 설명 연결 === -->
      <div class="badge-guideline">
        {% if final_label == 'issue' %}
          <p>
            체크리스트 기준으로
            <strong>“동일 유형 문의 인입 3건 이상 시 담당자 공유 권장”</strong>
            에 해당할 가능성이 높은 이슈입니다.
          </p>
        {% else %}
          <p>
            현재로서는 <strong>“즉시 공유가 필요한 이슈”</strong>에 해당하지 않을 가능성이 높습니다.
            다만, 아래 결과 진단과 <strong>업무 체크리스트</strong>를 반드시 함께 확인해 주세요.
          </p>
        {% endif %}
      </div>

      <!-- === FM / NK별 체크리스트 이미지(썸네일 + 클릭 시 확대) === -->
      <div class="checklist-section">
        <h3 class="checklist-title">업무 체크리스트</h3>
        <div class="checklist-body">
          <a
            class="checklist-thumb"
            href="{% if game == 'FM' %}{{ url_for('static', filename='fm_checklist.png') }}{% else %}{{ url_for('static', filename='nk_checklist.png') }}{% endif %}"
            target="_blank"
            rel="noopener noreferrer"
          >
            {% if game == 'FM' %}
              <img src="{{ url_for('static', filename='fm_checklist.png') }}" alt="FM 이슈 처리 체크리스트">
            {% else %}
              <img src="{{ url_for('static', filename='nk_checklist.png') }}" alt="NK 이슈 처리 체크리스트">
            {% endif %}
          </a>
          <div class="checklist-text">
            <p class="checklist-main">
              체크리스트 기준:
              동일 유형 문의가 <strong>인입 3건 이상</strong> 누적될 경우
              담당자에게 공유하는 것을 권장합니다.
            </p>
            <p class="checklist-sub">
              썸네일을 클릭하면 원본 체크리스트 이미지를 새 창에서 크게 확인할 수 있습니다.
            </p>
          </div>
        </div>
      </div>
      <!-- === /업무 기준 연결 영역 끝 === -->
    </div>

    {% if diagnostics %}
    <!-- 2-1. 결과 진단 (어디를 의심할지) -->
    <div class="card diag-card">
      <h3>2-1. 결과 진단 (어디를 의심할지)</h3>
      <div class="diag-header">
        {% if diagnostics.needs_attention %}
          <span class="badge badge-warning">주의 필요</span>
          <p class="diag-lead">
            툴 판단이 애매한 케이스입니다. 체크리스트/프로세스를 기준으로
            수동 검토를 꼭 진행해 주세요.
          </p>
        {% else %}
          <span class="badge badge-ok">안내</span>
          <p class="diag-lead">
            현재 기준으로는 RULES와 ML이 큰 충돌 없이 일치하는 케이스입니다.
            그래도 체크리스트와 함께 교차 확인해 주세요.
          </p>
        {% endif %}
      </div>

      <div class="diag-box">
        <ul class="diag-list">
          {% for msg in diagnostics.messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <div class="grid">
      <!-- RULES 기반 결과 -->
      <div class="card">
        <h3>RULES 기반 결과</h3>
        <ul class="result-list">
          <li><strong>라벨:</strong> {{ rule_result.label }}</li>
          <li><strong>카테고리:</strong> {{ rule_result.category }}</li>
          <li><strong>감지된 캐릭터:</strong>
            {% if rule_result.characters %}
              {{ rule_result.characters | join(', ') }}
            {% else %}
              없음
            {% endif %}
          </li>
          <li><strong>매칭 키워드:</strong>
            {% if rule_result.matched_keywords %}
              {{ rule_result.matched_keywords | join(', ') }}
            {% else %}
              없음
            {% endif %}
          </li>
        </ul>

        {% if summary_text %}
        <div class="summary-box">
          <h4>요약 (교육용)</h4>
          <pre class="summary-text">{{ summary_text }}</pre>
        </div>
        {% endif %}
      </div>

      <!-- 머신러닝 결과 -->
      <div class="card">
        <h3>머신러닝(ML) 결과</h3>
        <ul class="result-list">
          <li><strong>라벨:</strong> {{ ml_result.label }}</li>
          <li><strong>issue 확률:</strong> {{ (ml_result.prob_issue * 100) | round(1) }} %</li>
          <li><strong>non_issue 확률:</strong> {{ (ml_result.prob_non_issue * 100) | round(1) }} %</li>
        </ul>
      </div>

      <!-- 입력한 원문 -->
      <div class="card full-width">
        <h3>입력한 원문</h3>
        <pre class="raw-text">{{ content }}</pre>
      </div>
    </div>

    <!-- 3. 피드백 기록 (나딘 전용, 5순위 패치) -->
    <div class="card feedback-card">
      <h3>3. 피드백 기록 (나딘 전용)</h3>

      {% if feedback_saved %}
        <p class="feedback-save-message">
          피드백이 저장되었습니다. 동일한 텍스트는 다음부터 이 기준으로 자동 해석됩니다.
        </p>
      {% endif %}

      <p class="feedback-desc">
        이 케이스에 대한 <strong>정답 라벨</strong>과 <strong>정확한 카테고리</strong>를 기록해 두면,
        다음번부터 RULES/ML 결과보다 이 값을 우선 적용합니다.
      </p>

      <form method="post" class="issue-form feedback-form">
        <input type="hidden" name="action" value="feedback">
        <input type="hidden" name="game" value="{{ game }}">
        <input type="hidden" name="content" value="{{ content }}">
        <input type="hidden" name="text_hash" value="{{ text_hash or '' }}">

        <div class="form-row inline-row">
          <div class="field">
            <label for="feedback_label">정답 라벨</label>
            <select id="feedback_label" name="feedback_label">
              <option value="">선택 안 함</option>
              <option value="ISSUE">ISSUE</option>
              <option value="NON ISSUE">NON ISSUE</option>
            </select>
          </div>
          <div class="field">
            <label for="feedback_category">정답 카테고리</label>
            <input
              id="feedback_category"
              name="feedback_category"
              type="text"
              placeholder="[FM] 버그/오류 제보 (A) - 게임 내 기능/전투 등 오류/버그 등"
            >
          </div>
        </div>

        <div class="form-row">
          <label for="feedback_comment">메모 (선택)</label>
          <textarea
            id="feedback_comment"
            name="feedback_comment"
            rows="2"
            placeholder="나중에 재학습에 참고할 간단 메모를 남겨 주세요."
          ></textarea>
        </div>

        <div class="form-row buttons">
          <button type="submit">피드백 저장</button>
        </div>
      </form>
    </div>
  </section>
  {% endif %}

  <footer class="footer">
    <p>내부 교육용 · 로컬 환경에서만 사용</p>
  </footer>
</div>
</body>
</html>
